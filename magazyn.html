<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>MagazynRur</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #22263a;
    --border: #2e3350;
    --accent: #4f8ef7;
    --accent2: #f7934f;
    --green: #4fcc7a;
    --red: #f75f5f;
    --yellow: #f7d14f;
    --text: #e8eaf0;
    --text2: #8b90a8;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
  }

  /* NAV */
  .nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
    display: flex;
    align-items: center;
    height: 52px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .nav-logo {
    font-family: var(--mono);
    font-weight: 600;
    font-size: 16px;
    color: var(--accent);
    letter-spacing: -0.5px;
    flex: 1;
  }
  .nav-logo span { color: var(--text2); }

  /* TABS */
  .tabs {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 12px 16px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* CONTENT */
  .page { display: none; padding: 16px; max-width: 700px; margin: 0 auto; }
  .page.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .card-title {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  /* BUTTONS */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border-radius: 6px;
    border: none;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #3a7ef0; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
  .btn-success { background: var(--green); color: #000; }
  .btn-sm { padding: 6px 10px; font-size: 12px; }
  .btn-full { width: 100%; justify-content: center; }

  /* INPUTS */
  .input, .select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .input:focus, .select:focus { border-color: var(--accent); }
  .select option { background: var(--bg); }
  .label {
    display: block;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 4px;
    font-weight: 500;
  }
  .form-group { margin-bottom: 12px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* BADGES */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    font-family: var(--mono);
  }
  .badge-blue { background: rgba(79,142,247,0.15); color: var(--accent); }
  .badge-green { background: rgba(79,204,122,0.15); color: var(--green); }
  .badge-yellow { background: rgba(247,209,79,0.15); color: var(--yellow); }
  .badge-red { background: rgba(247,95,95,0.15); color: var(--red); }
  .badge-orange { background: rgba(247,147,79,0.15); color: var(--accent2); }

  /* PIPE CARD */
  .pipe-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .pipe-card:hover { border-color: var(--accent); }
  .pipe-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
  .pipe-sig {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
  }
  .pipe-dims { font-family: var(--mono); font-size: 12px; color: var(--text2); }
  .pipe-len {
    font-family: var(--mono);
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  .pipe-len span { font-size: 13px; color: var(--text2); }
  .pipe-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
  .pipe-date { font-size: 11px; color: var(--text2); }

  /* STAT CARDS */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    text-align: center;
  }
  .stat-num { font-family: var(--mono); font-size: 28px; font-weight: 600; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--text2); margin-top: 2px; }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 200;
    padding: 16px;
    overflow-y: auto;
  }
  .modal-overlay.open { display: flex; align-items: flex-start; justify-content: center; padding-top: 40px; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    width: 100%;
    max-width: 500px;
  }
  .modal-title {
    font-family: var(--mono);
    font-size: 14px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .close-btn {
    background: none;
    border: none;
    color: var(--text2);
    font-size: 20px;
    cursor: pointer;
    padding: 0 4px;
  }

  /* IMAGE PREVIEW */
  .img-preview {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
    display: none;
    margin-bottom: 12px;
    max-height: 200px;
    object-fit: contain;
    background: var(--bg);
  }

  /* OCR STATUS */
  .ocr-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin-bottom: 12px;
  }
  .ocr-status.loading { background: rgba(247,209,79,0.1); color: var(--yellow); }
  .ocr-status.success { background: rgba(79,204,122,0.1); color: var(--green); }
  .ocr-status.error { background: rgba(247,95,95,0.1); color: var(--red); }
  .ocr-status.hidden { display: none; }

  /* HISTORY */
  .history-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .history-item:last-child { border-bottom: none; }
  .history-date { font-family: var(--mono); font-size: 11px; color: var(--text2); }
  .history-desc { margin-top: 2px; }

  /* TASK CARD */
  .task-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--yellow);
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 8px;
  }
  .task-title { font-weight: 500; margin-bottom: 4px; }
  .task-desc { font-size: 12px; color: var(--text2); }
  .task-actions { margin-top: 10px; display: flex; gap: 8px; }

  /* ENTNAHME */
  .entnahme-doc {
    background: #fff;
    color: #000;
    padding: 20px;
    border-radius: 8px;
    font-family: 'Arial', sans-serif;
    font-size: 12px;
    line-height: 1.5;
  }
  .entnahme-doc h2 { text-align: center; font-size: 16px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .entnahme-row { display: flex; gap: 16px; margin-bottom: 8px; }
  .entnahme-field { flex: 1; }
  .entnahme-field label { font-size: 10px; color: #666; text-transform: uppercase; }
  .entnahme-field .val { border-bottom: 1px solid #999; padding: 2px 0; min-height: 20px; }
  .entnahme-section { margin-top: 12px; }
  .entnahme-section h3 { font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #000; padding-bottom: 2px; margin-bottom: 8px; }
  .entnahme-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
  .entnahme-table th { font-size: 10px; text-align: left; padding: 3px 4px; background: #f0f0f0; border: 1px solid #ccc; }
  .entnahme-table td { padding: 3px 4px; border: 1px solid #ccc; font-family: monospace; }

  /* SEARCH */
  .search-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  /* EMPTY STATE */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text2);
  }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }

  /* SPINNER */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: inline-block;
  }

  .divider { height: 1px; background: var(--border); margin: 12px 0; }

  /* FILE INPUT HIDDEN */
  input[type=file] { display: none; }
</style>
</head>
<body>

<div class="nav">
  <div class="nav-logo">Magazyn<span>Rur</span></div>
  <div id="taskBadge" style="display:none">
    <span class="badge badge-yellow" id="taskCount">0 zada≈Ñ</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('baza')">üì¶ Baza</div>
  <div class="tab" onclick="switchTab('skan')">üì∑ Skanuj</div>
  <div class="tab" onclick="switchTab('projekt')">üìã Projekt</div>
  <div class="tab" onclick="switchTab('historia')">üìä Historia</div>
  <div class="tab" onclick="switchTab('zadania')">‚úÖ Zadania</div>
</div>

<!-- ===== BAZA ===== -->
<div class="page active" id="page-baza">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-num" id="statRury">0</div>
      <div class="stat-label">Rur w bazie</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="statMetry">0</div>
      <div class="stat-label">Metr√≥w ≈ÇƒÖcznie</div>
    </div>
  </div>

  <div class="search-bar">
    <input class="input" id="searchInput" placeholder="Szukaj sygnatury, wymiaru..." oninput="renderBaza()">
    <select class="select" style="width:auto" id="filterStatus" onchange="renderBaza()">
      <option value="">Wszystkie</option>
      <option value="magazyn">Magazyn</option>
      <option value="hala">Hala</option>
    </select>
  </div>

  <div id="bazaList"></div>
</div>

<!-- ===== SKAN ===== -->
<div class="page" id="page-skan">
  <div class="card">
    <div class="card-title">Dodaj rurƒô / skanuj etykietƒô</div>

    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="document.getElementById('fileCamera').click()">üì∑ Zr√≥b zdjƒôcie</button>
      <button class="btn btn-secondary" onclick="document.getElementById('fileGallery').click()">üñº Z galerii</button>
      <button class="btn btn-secondary" onclick="showManualForm()">‚úèÔ∏è Rƒôcznie</button>
    </div>
    <input type="file" id="fileCamera" accept="image/*" capture="environment" onchange="handleScan(this)">
    <input type="file" id="fileGallery" accept="image/*" onchange="handleScan(this)">

    <img id="scanPreview" class="img-preview" alt="PodglƒÖd">

    <div id="ocrStatus" class="ocr-status hidden"></div>

    <div id="scanForm" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="label">Sygnatura (Chargennummer)*</label>
          <input class="input" id="fSig" placeholder="np. 1146/56381-B">
        </div>
        <div class="form-group">
          <label class="label">D≈Çugo≈õƒá (m)*</label>
          <input class="input" id="fLen" type="number" step="0.01" placeholder="np. 5.38">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="label">≈örednica (mm)*</label>
          <input class="input" id="fDiam" placeholder="np. 1016">
        </div>
        <div class="form-group">
          <label class="label">Grubo≈õƒá (mm)*</label>
          <input class="input" id="fThick" placeholder="np. 6.3">
        </div>
      </div>
      <div class="form-group">
        <label class="label">Typ spawania</label>
        <select class="select" id="fWeld">
          <option value="spiralnaht">Spiralnaht (spiralna)</option>
          <option value="laengsnaht">L√§ngsnaht (prosta)</option>
          <option value="nahtlos">Nahtlos (bez szwu)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="label">Typ</label>
        <select class="select" id="fType">
          <option value="rura">Rura (‚â•6m)</option>
          <option value="resto">Resto (&lt;6m)</option>
        </select>
      </div>
      <div class="divider"></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary btn-full" onclick="savePipe()">üíæ Zapisz do bazy</button>
        <button class="btn btn-secondary" onclick="resetScan()">‚úï</button>
      </div>
    </div>

    <div id="serialMode" style="display:none;margin-top:12px">
      <div class="ocr-status success">üîÑ Tryb seryjny ‚Äî skanuj kolejne etykiety</div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Tryb seryjny</div>
    <p style="color:var(--text2);font-size:13px;margin-bottom:12px">Skanuj wiele etykiet bez przerwy ‚Äî po ka≈ºdym zapisie od razu mo≈ºesz skanowaƒá nastƒôpnƒÖ.</p>
    <button class="btn btn-secondary btn-full" id="serialBtn" onclick="toggleSerial()">üîÑ W≈ÇƒÖcz tryb seryjny</button>
  </div>
</div>

<!-- ===== PROJEKT ===== -->
<div class="page" id="page-projekt">
  <div class="card">
    <div class="card-title">Skanuj projekt / dokument</div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="document.getElementById('fileProjCamera').click()">üì∑ Zr√≥b zdjƒôcie</button>
      <button class="btn btn-secondary" onclick="document.getElementById('fileProjGallery').click()">üñº Z galerii</button>
      <button class="btn btn-secondary" onclick="showProjForm()">‚úèÔ∏è Wpisz rƒôcznie</button>
    </div>
    <input type="file" id="fileProjCamera" accept="image/*" capture="environment" onchange="handleProjScan(this)">
    <input type="file" id="fileProjGallery" accept="image/*" onchange="handleProjScan(this)">
    <img id="projPreview" class="img-preview" alt="PodglƒÖd projektu">
    <div id="projOcrStatus" class="ocr-status hidden"></div>
  </div>

  <div id="projForm" style="display:none">
    <div class="card">
      <div class="card-title">Dane projektu</div>
      <div class="form-row">
        <div class="form-group">
          <label class="label">Nr projektu*</label>
          <input class="input" id="pNr" placeholder="np. 6758-F-E">
        </div>
        <div class="form-group">
          <label class="label">Data</label>
          <input class="input" id="pDate" type="date">
        </div>
      </div>
      <div class="form-group">
        <label class="label">Opis / nazwa</label>
        <input class="input" id="pDesc" placeholder="np. Frankfurt Cloud HQ - Komin A">
      </div>
      <div class="form-group">
        <label class="label">Pracownik (Bearbeiter)</label>
        <input class="input" id="pWorker" placeholder="Twoje imiƒô">
      </div>
    </div>

    <div class="card" id="projPositions">
      <div class="card-title">Pozycje Tragrohr</div>
      <div id="positionsList"></div>
      <button class="btn btn-secondary btn-full" onclick="addPosition()" style="margin-top:8px">+ Dodaj pozycjƒô</button>
    </div>

    <button class="btn btn-primary btn-full" onclick="findMaterial()" style="margin-bottom:12px">üîç Dobierz materia≈Ç z bazy</button>
  </div>

  <!-- WYNIK DOBORU -->
  <div id="projResult" style="display:none"></div>
</div>

<!-- ===== HISTORIA ===== -->
<div class="page" id="page-historia">
  <div class="card">
    <div class="card-title">Szukaj w historii</div>
    <div class="form-row">
      <div class="form-group">
        <input class="input" id="histSearch" placeholder="Nr projektu, sygnatura...">
      </div>
      <div class="form-group">
        <input class="input" id="histDate" type="date">
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="searchHistory()">üîç Szukaj</button>
  </div>
  <div id="historyResults"></div>
</div>

<!-- ===== ZADANIA ===== -->
<div class="page" id="page-zadania">
  <div id="tasksList"></div>
</div>

<!-- ===== MODAL: SZCZEG√ì≈ÅY RURY ===== -->
<div class="modal-overlay" id="pipeModal">
  <div class="modal">
    <div class="modal-title">
      <span id="modalSig">Rura</span>
      <button class="close-btn" onclick="closeModal('pipeModal')">‚úï</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- ===== MODAL: ENTNAHMESCHEIN ===== -->
<div class="modal-overlay" id="entnahmeModal">
  <div class="modal" style="max-width:600px">
    <div class="modal-title">
      <span>Entnahmeschein</span>
      <button class="close-btn" onclick="closeModal('entnahmeModal')">‚úï</button>
    </div>
    <div id="entnahmeBody"></div>
    <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="printEntnahme()">üñ® Drukuj</button>
      <button class="btn btn-secondary" onclick="exportTXT()">üìÑ Eksport TXT</button>
      <button class="btn btn-secondary" onclick="exportEmail()">üìß Email</button>
    </div>
  </div>
</div>

<script>
// ===================== STATE =====================
const BASE_URL = 'https://kreator50-sketch.github.io/Magazyn';
const VISION_KEY = 'AIzaSyAT4hXe-LEurS05xzEyHuYw3RvE9YWnaJI';
let db = JSON.parse(localStorage.getItem('magazynDB') || '{"pipes":[],"tasks":[],"history":[],"nextResto":1171}');
let serialMode = false;
let currentEntnahme = null;
let editingPipeId = null;

async function runVisionOCR(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async function(e) {
      const b64 = e.target.result.split(',')[1];
      try {
        const response = await fetch(
          `https://vision.googleapis.com/v1/images:annotate?key=${VISION_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              requests: [{
                image: { content: b64 },
                features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
              }]
            })
          }
        );
        const data = await response.json();
        if (data.responses && data.responses[0] && data.responses[0].fullTextAnnotation) {
          resolve(data.responses[0].fullTextAnnotation.text);
        } else {
          reject(new Error('Brak tekstu'));
        }
      } catch(err) {
        reject(err);
      }
    };
    reader.readAsDataURL(file);
  });
}

function saveDB() { localStorage.setItem('magazynDB', JSON.stringify(db)); }

// ===================== TABS =====================
function switchTab(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'baza') renderBaza();
  if (name === 'historia') renderHistory();
  if (name === 'zadania') renderTasks();
}

// ===================== RENDER BAZA =====================
function renderBaza() {
  const q = (document.getElementById('searchInput').value || '').toLowerCase();
  const fs = document.getElementById('filterStatus').value;
  let pipes = db.pipes.filter(p => {
    const match = !q || p.sig.toLowerCase().includes(q) || 
      (p.diam + 'x' + p.thick).includes(q) ||
      (p.type === 'resto' && ('resto').includes(q));
    const statusMatch = !fs || p.status === fs;
    return match && statusMatch;
  });

  // stats
  document.getElementById('statRury').textContent = db.pipes.length;
  const totalM = db.pipes.reduce((s, p) => s + parseFloat(p.len || 0), 0);
  document.getElementById('statMetry').textContent = totalM.toFixed(1) + 'm';

  const list = document.getElementById('bazaList');
  if (!pipes.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üì¶</div><div>Brak rur w bazie</div><div style="margin-top:8px;font-size:12px">Przejd≈∫ do "Skanuj" ≈ºeby dodaƒá</div></div>`;
    return;
  }
  list.innerHTML = pipes.map(p => `
    <div class="pipe-card" onclick="showPipeModal('${p.id}')">
      <div class="pipe-header">
        <span class="pipe-sig">${p.sig}</span>
        <span class="pipe-dims">√ò${p.diam}√ó${p.thick}mm</span>
        <span class="badge ${p.type === 'resto' ? 'badge-orange' : 'badge-blue'}">${p.type === 'resto' ? 'RESTO' : 'RURA'}</span>
        <span class="badge ${p.status === 'hala' ? 'badge-yellow' : 'badge-green'}">${p.status === 'hala' ? 'HALA' : 'MAGAZYN'}</span>
      </div>
      <div class="pipe-len">${parseFloat(p.len).toFixed(2)}<span> m</span></div>
      <div class="pipe-footer">
        <span class="pipe-date">${p.weld || ''}</span>
        <span class="pipe-date">${formatDate(p.dateAdded)}</span>
      </div>
    </div>
  `).join('');

  // tasks badge
  const pending = db.tasks.filter(t => !t.done).length;
  document.getElementById('taskBadge').style.display = pending ? '' : 'none';
  document.getElementById('taskCount').textContent = pending + ' zada≈Ñ';
}

// ===================== PIPE MODAL =====================
function showPipeModal(id) {
  const p = db.pipes.find(x => x.id === id);
  if (!p) return;
  editingPipeId = id;
  document.getElementById('modalSig').textContent = p.sig;
  const hist = (p.history || []).map(h => `
    <div class="history-item">
      <div class="history-date">${formatDate(h.date)}</div>
      <div class="history-desc">${h.desc}</div>
    </div>
  `).join('');
  document.getElementById('modalBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div><div class="label">D≈Çugo≈õƒá</div><div style="font-family:var(--mono);font-size:20px;font-weight:600">${parseFloat(p.len).toFixed(2)}m</div></div>
      <div><div class="label">Wymiar</div><div style="font-family:var(--mono)">√ò${p.diam}√ó${p.thick}mm</div></div>
      <div><div class="label">Typ</div><div>${p.type === 'resto' ? '<span class="badge badge-orange">RESTO</span>' : '<span class="badge badge-blue">RURA</span>'}</div></div>
      <div><div class="label">Status</div><div>${p.status === 'hala' ? '<span class="badge badge-yellow">HALA</span>' : '<span class="badge badge-green">MAGAZYN</span>'}</div></div>
      <div><div class="label">Spawanie</div><div style="font-size:12px">${p.weld || '-'}</div></div>
      <div><div class="label">Dodano</div><div style="font-size:12px">${formatDate(p.dateAdded)}</div></div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
      <button class="btn btn-secondary btn-sm" onclick="editLen()">‚úèÔ∏è Zmie≈Ñ d≈Çugo≈õƒá</button>
      <button class="btn btn-secondary btn-sm" onclick="editSig()">‚úèÔ∏è Zmie≈Ñ sygnaturƒô</button>
      <button class="btn btn-secondary btn-sm" onclick="toggleStatus()">üîÑ Zmie≈Ñ status</button>
      <button class="btn btn-danger btn-sm" onclick="deletePipe()">üóë Usu≈Ñ</button>
    </div>

    <div class="card-title" style="margin-bottom:8px">Historia modyfikacji</div>
    ${hist || '<div style="color:var(--text2);font-size:13px">Brak historii</div>'}
  `;
  document.getElementById('pipeModal').classList.add('open');
}

function editLen() {
  const p = db.pipes.find(x => x.id === editingPipeId);
  const newLen = prompt('Nowa d≈Çugo≈õƒá (m):', p.len);
  if (!newLen || isNaN(parseFloat(newLen))) return;
  const old = p.len;
  p.len = parseFloat(newLen).toFixed(2);
  p.type = parseFloat(p.len) < 6 ? 'resto' : 'rura';
  p.dateModified = new Date().toISOString();
  if (!p.history) p.history = [];
  p.history.push({ date: new Date().toISOString(), desc: `Zmiana d≈Çugo≈õci: ${old}m ‚Üí ${p.len}m` });
  addHistory({ type: 'mod', pipeId: p.id, sig: p.sig, desc: `Zmiana d≈Çugo≈õci ${old}m ‚Üí ${p.len}m` });
  saveDB();
  showPipeModal(editingPipeId);
  renderBaza();
}

function editSig() {
  const p = db.pipes.find(x => x.id === editingPipeId);
  const newSig = prompt('Nowa sygnatura:', p.sig);
  if (!newSig) return;
  const old = p.sig;
  p.sig = newSig.trim();
  if (!p.history) p.history = [];
  p.history.push({ date: new Date().toISOString(), desc: `Zmiana sygnatury: ${old} ‚Üí ${p.sig}` });
  saveDB();
  showPipeModal(editingPipeId);
  renderBaza();
}

function toggleStatus() {
  const p = db.pipes.find(x => x.id === editingPipeId);
  p.status = p.status === 'hala' ? 'magazyn' : 'hala';
  if (!p.history) p.history = [];
  p.history.push({ date: new Date().toISOString(), desc: `Status zmieniony na: ${p.status}` });
  saveDB();
  showPipeModal(editingPipeId);
  renderBaza();
}

function deletePipe() {
  if (!confirm('Na pewno usunƒÖƒá tƒô rurƒô z bazy?')) return;
  db.pipes = db.pipes.filter(x => x.id !== editingPipeId);
  saveDB();
  closeModal('pipeModal');
  renderBaza();
}

// ===================== SCAN / OCR =====================
function showManualForm() {
  document.getElementById('scanPreview').style.display = 'none';
  document.getElementById('ocrStatus').className = 'ocr-status hidden';
  document.getElementById('scanForm').style.display = 'block';
  clearScanForm();
}

function resetScan() {
  document.getElementById('scanPreview').style.display = 'none';
  document.getElementById('ocrStatus').className = 'ocr-status hidden';
  document.getElementById('scanForm').style.display = 'none';
  clearScanForm();
}

function clearScanForm() {
  ['fSig','fLen','fDiam','fThick'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('fWeld').value = 'spiralnaht';
  document.getElementById('fType').value = 'rura';
}

function handleScan(input) {
  const file = input.files[0];
  if (!file) return;
  const capturedFile = file;
  input.value = '';

  const preview = document.getElementById('scanPreview');
  const reader = new FileReader();
  reader.onload = function(e) {
    preview.src = e.target.result;
    preview.style.display = 'block';
    document.getElementById('scanForm').style.display = 'none';

    const status = document.getElementById('ocrStatus');
    status.className = 'ocr-status loading';
    status.innerHTML = '<div class="spinner"></div> Rozpoznajƒô etykietƒô...';

    try {
      const text = await runVisionOCR(capturedFile);
      console.log('OCR TEXT:', text);
      parseAndFillLabel(text);
      status.className = 'ocr-status success';
      status.textContent = '‚úÖ Rozpoznano! Sprawd≈∫ dane.';
      document.getElementById('scanForm').style.display = 'block';
    } catch(err) {
      status.className = 'ocr-status error';
      status.textContent = '‚ö†Ô∏è Nie uda≈Ço siƒô rozpoznaƒá. Wpisz rƒôcznie.';
      document.getElementById('scanForm').style.display = 'block';
      clearScanForm();
    }
  };
  reader.readAsDataURL(file);
}

function parseAndFillLabel(text) {
  // Sygnatura - Chargennummer or Artikel
  let sig = '';
  const sigMatch = text.match(/[Cc]hargen(?:nummer)?[:\s]+([A-Za-z0-9\/\-\.]+)/);
  const artMatch = text.match(/[Aa]rtikel[:\s]+([A-Za-z0-9\/\-\.]+)/);
  if (sigMatch) sig = sigMatch[1];
  else if (artMatch) sig = artMatch[1];

  // D≈Çugo≈õƒá - Restmenge
  let len = '';
  const restMatch = text.match(/[Rr]estmenge[:\s]+([\d,\.]+)\s*[Mm]/);
  const gebrMatch = text.match(/[Gg]ebrauchte\s*[Mm]enge[:\s]+([\d,\.]+)\s*[Mm]/);
  if (restMatch) len = restMatch[1].replace(',', '.');
  else if (gebrMatch) len = gebrMatch[1].replace(',', '.');

  // Wymiary - √ò1016x6,3 lub 1016x6.3 lub 1016/6.3
  let diam = '', thick = '';
  const dimMatch = text.match(/[√òO\u00d8]?\s*(\d{3,4})[,\.]?\d*\s*[xX\*\/√ó]\s*([\d,\.]+)/);
  if (dimMatch) {
    diam = dimMatch[1];
    thick = dimMatch[2].replace(',', '.');
  }

  // Spawanie
  let weld = 'spiralnaht';
  if (/[Ll][√§a]ngs/i.test(text)) weld = 'laengsnaht';
  if (/[Nn]ahtlos/i.test(text)) weld = 'nahtlos';

  if (sig) document.getElementById('fSig').value = sig;
  if (len) {
    const lenNum = parseFloat(len);
    document.getElementById('fLen').value = lenNum;
    document.getElementById('fType').value = lenNum < 6 ? 'resto' : 'rura';
  }
  if (diam) document.getElementById('fDiam').value = diam;
  if (thick) document.getElementById('fThick').value = thick;
  document.getElementById('fWeld').value = weld;
}

function savePipe() {
  const sig = document.getElementById('fSig').value.trim();
  const len = parseFloat(document.getElementById('fLen').value);
  const diam = document.getElementById('fDiam').value.trim();
  const thick = document.getElementById('fThick').value.trim();
  const weld = document.getElementById('fWeld').value;
  const type = parseFloat(len) < 6 ? 'resto' : 'rura';

  if (!sig || !len || !diam || !thick || isNaN(len)) {
    alert('Wype≈Çnij pola: sygnatura, d≈Çugo≈õƒá, ≈õrednica, grubo≈õƒá!');
    return;
  }

  // Check duplicate sig
  const existing = db.pipes.find(p => p.sig === sig);
  if (existing) {
    if (!confirm(`Rura z sygnaturƒÖ "${sig}" ju≈º istnieje w bazie.\nCzy to kolejna rura z tej partii?`)) return;
  }

  const pipe = {
    id: 'p' + Date.now() + Math.random().toString(36).slice(2, 6),
    sig, len: len.toFixed(2), diam, thick, weld, type,
    status: 'magazyn',
    dateAdded: new Date().toISOString(),
    history: [{ date: new Date().toISOString(), desc: 'Przyjƒôcie na magazyn' }]
  };

  // Auto-assign resto number
  if (type === 'resto' && !sig.match(/^\d{4}$/)) {
    // keep original sig, no override
  }

  db.pipes.push(pipe);
  addHistory({ type: 'add', pipeId: pipe.id, sig: pipe.sig, desc: `Dodano ${type} √ò${diam}√ó${thick}mm, d≈Ç. ${len}m` });
  saveDB();
  renderBaza();

  const ocrStatus = document.getElementById('ocrStatus');
  ocrStatus.className = 'ocr-status success';
  ocrStatus.textContent = `‚úÖ Zapisano! ${sig} (${len}m)`;

  if (serialMode) {
    clearScanForm();
    document.getElementById('scanForm').style.display = 'none';
    document.getElementById('scanPreview').style.display = 'none';
  } else {
    resetScan();
  }
}

// ===================== SERIAL MODE =====================
function toggleSerial() {
  serialMode = !serialMode;
  document.getElementById('serialBtn').textContent = serialMode ? 'üîÑ Wy≈ÇƒÖcz tryb seryjny' : 'üîÑ W≈ÇƒÖcz tryb seryjny';
  document.getElementById('serialBtn').className = serialMode ? 'btn btn-success btn-full' : 'btn btn-secondary btn-full';
}

// ===================== PROJEKT =====================
let positions = [];

function showProjForm() {
  document.getElementById('projForm').style.display = 'block';
  document.getElementById('pDate').value = new Date().toISOString().split('T')[0];
  if (!positions.length) addPosition();
}

function handleProjScan(input) {
  const file = input.files[0];
  if (!file) return;
  const capturedFile = file;
  input.value = '';

  const preview = document.getElementById('projPreview');
  const reader = new FileReader();
  reader.onload = function(e) {
    preview.src = e.target.result;
    preview.style.display = 'block';

    const status = document.getElementById('projOcrStatus');
    status.className = 'ocr-status loading';
    status.innerHTML = '<div class="spinner"></div> Rozpoznajƒô projekt...';

    try {
      const text = await runVisionOCR(capturedFile);
      parseProjText(text);
      status.className = 'ocr-status success';
      status.textContent = '‚úÖ Rozpoznano! Sprawd≈∫ dane.';
      document.getElementById('projForm').style.display = 'block';
    } catch(err) {
      status.className = 'ocr-status error';
      status.textContent = '‚ö†Ô∏è Nie uda≈Ço siƒô. Wpisz rƒôcznie.';
      document.getElementById('projForm').style.display = 'block';
      if (!positions.length) addPosition();
    }
  };
  reader.readAsDataURL(file);
}

function parseProjText(text) {
  // Nr projektu
  const nrMatch = text.match(/[Pp]rojekt[\s\-:Nr\.]+([A-Za-z0-9\-]+)/);
  if (nrMatch) document.getElementById('pNr').value = nrMatch[1];

  // Data
  const dateMatch = text.match(/[Dd]atum[:\s]+(\d{1,2}[\.\-]\d{1,2}[\.\-]\d{2,4})/);
  if (dateMatch) {
    const parts = dateMatch[1].split(/[\.\-]/);
    if (parts.length === 3) {
      const y = parts[2].length === 2 ? '20' + parts[2] : parts[2];
      document.getElementById('pDate').value = `${y}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
  }

  // Pozycje Tragrohr
  positions = [];
  const lines = text.split('\n');
  for (const line of lines) {
    if (/[Tt]ragrohr/i.test(line)) {
      const dimM = line.match(/[√òO\u00d8]?\s*(\d{3,4})\s*[xX√ó\/]\s*([\d,\.]+)/);
      const lenM = line.match(/[Il=]\s*([\d,\.]+)\s*(?:mm)?/);
      if (dimM && lenM) {
        const lenMm = parseFloat(lenM[1].replace(',', '.'));
        positions.push({
          name: line.trim().slice(0, 40),
          diam: dimM[1],
          thick: dimM[2].replace(',', '.'),
          len: lenMm > 100 ? (lenMm / 1000).toFixed(3) : lenMm.toFixed(3)
        });
      }
    }
  }
  if (!positions.length) addPosition();
  renderPositions();
}

function addPosition() {
  positions.push({ name: '', diam: '', thick: '', len: '' });
  renderPositions();
}

function renderPositions() {
  document.getElementById('positionsList').innerHTML = positions.map((p, i) => `
    <div style="background:var(--bg);border-radius:6px;padding:10px;margin-bottom:8px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-family:var(--mono);font-size:12px;color:var(--text2)">Pozycja ${i+1}</span>
        ${positions.length > 1 ? `<button class="btn btn-danger btn-sm" onclick="removePosition(${i})">‚úï</button>` : ''}
      </div>
      <div class="form-group">
        <input class="input" placeholder="Opis (np. Tragrohrl√§nge 1)" value="${p.name}" oninput="positions[${i}].name=this.value">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="label">≈örednica (mm)</label>
          <input class="input" placeholder="np. 1016" value="${p.diam}" oninput="positions[${i}].diam=this.value">
        </div>
        <div class="form-group">
          <label class="label">Grubo≈õƒá (mm)</label>
          <input class="input" placeholder="np. 6.3" value="${p.thick}" oninput="positions[${i}].thick=this.value">
        </div>
      </div>
      <div class="form-group">
        <label class="label">Potrzebna d≈Çugo≈õƒá (m)</label>
        <input class="input" type="number" step="0.001" placeholder="np. 8.500" value="${p.len}" oninput="positions[${i}].len=this.value">
      </div>
    </div>
  `).join('');
}

function removePosition(i) {
  positions.splice(i, 1);
  renderPositions();
}

function findMaterial() {
  const nr = document.getElementById('pNr').value.trim();
  const date = document.getElementById('pDate').value;
  const desc = document.getElementById('pDesc').value.trim();
  const worker = document.getElementById('pWorker').value.trim();

  if (!nr) { alert('Wpisz numer projektu!'); return; }
  if (!positions.length || !positions[0].diam) { alert('Dodaj przynajmniej jednƒÖ pozycjƒô!'); return; }

  // Dob√≥r materia≈Çu dla ka≈ºdej pozycji
  const results = [];
  for (const pos of positions) {
    if (!pos.diam || !pos.len) continue;
    const needed = parseFloat(pos.len);
    const matchingPipes = db.pipes.filter(p => 
      p.diam === pos.diam && 
      p.thick === pos.thick &&
      p.status === 'magazyn'
    ).sort((a, b) => parseFloat(a.len) - parseFloat(b.len));

    let toUse = [];
    let remaining = needed;
    
    // Najpierw szukaj resto kt√≥re pasujƒÖ
    const restos = matchingPipes.filter(p => p.type === 'resto');
    for (const r of restos) {
      if (remaining <= 0) break;
      if (parseFloat(r.len) <= remaining + 0.5) {
        toUse.push(r);
        remaining -= parseFloat(r.len);
      } else if (parseFloat(r.len) >= remaining - 0.1) {
        toUse.push(r);
        remaining = 0;
      }
    }
    // Potem ca≈Çe rury
    if (remaining > 0) {
      const fullPipes = matchingPipes.filter(p => p.type === 'rura');
      for (const rp of fullPipes) {
        if (remaining <= 0) break;
        toUse.push(rp);
        remaining -= parseFloat(rp.len);
      }
    }

    results.push({ pos, toUse, needed, remaining: Math.abs(remaining) });
  }

  // Oblicz resty
  const entnahmeLines = [];
  const restoLines = [];
  const newTasks = [];

  for (const r of results) {
    for (const p of r.toUse) {
      entnahmeLines.push({ sig: p.sig, len: p.len, diam: p.diam, thick: p.thick, type: p.type });
    }
    // Oblicz ile zostanie
    if (r.toUse.length > 0) {
      const lastPipe = r.toUse[r.toUse.length - 1];
      const lastLen = parseFloat(lastPipe.len);
      const usedFromLast = r.needed - r.toUse.slice(0,-1).reduce((s,p) => s + parseFloat(p.len), 0);
      const restoLen = lastLen - usedFromLast;
      if (restoLen > 0.05) {
        let restoSig;
        if (restoLen < 6) {
          restoSig = String(db.nextResto++);
          saveDB();
        } else {
          restoSig = lastPipe.sig;
        }
        restoLines.push({ sig: restoSig, origSig: lastPipe.sig, len: restoLen.toFixed(2), diam: lastPipe.diam, thick: lastPipe.thick, proj: nr });
        newTasks.push({
          id: 't' + Date.now() + Math.random().toString(36).slice(2,5),
          type: 'etykieta',
          desc: `Zeskanuj etykietƒô resto ${restoSig} (√ò${lastPipe.diam}√ó${lastPipe.thick}mm, ~${restoLen.toFixed(2)}m) z projektu ${nr}`,
          projNr: nr,
          restoSig,
          restoLen: restoLen.toFixed(2),
          done: false,
          date: new Date().toISOString()
        });
      }
    }
  }

  // Zapisz w historii
  addHistory({
    type: 'projekt',
    projNr: nr,
    desc: `Projekt ${nr} ‚Äî ${entnahmeLines.length} rur wys≈Çanych na halƒô`,
    worker,
    date: date || new Date().toISOString(),
    entnahme: entnahmeLines,
    restos: restoLines
  });

  // Dodaj zadania
  db.tasks.push(...newTasks);

  // Aktualizuj status rur
  for (const r of results) {
    for (const p of r.toUse) {
      const pipe = db.pipes.find(x => x.id === p.id);
      if (pipe) {
        pipe.status = 'hala';
        if (!pipe.history) pipe.history = [];
        pipe.history.push({ date: new Date().toISOString(), desc: `Wys≈Çana na halƒô ‚Äî projekt ${nr}` });
      }
    }
  }
  saveDB();

  // Generuj Entnahmeschein
  currentEntnahme = { nr, date: date || new Date().toISOString().split('T')[0], desc, worker, entnahme: entnahmeLines, restos: restoLines };

  // Poka≈º wynik
  const resultDiv = document.getElementById('projResult');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = `
    <div class="card">
      <div class="card-title">Wynik doboru materia≈Çu</div>
      ${results.map(r => `
        <div style="margin-bottom:12px">
          <div style="font-weight:500;margin-bottom:6px">${r.pos.name || 'Pozycja'} ‚Äî √ò${r.pos.diam}√ó${r.pos.thick}mm, ${r.pos.len}m</div>
          ${r.toUse.length ? r.toUse.map(p => `
            <div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg);border-radius:4px;margin-bottom:4px">
              <span class="badge ${p.type==='resto'?'badge-orange':'badge-blue'}">${p.type.toUpperCase()}</span>
              <span style="font-family:var(--mono)">${p.sig}</span>
              <span style="color:var(--text2)">${parseFloat(p.len).toFixed(2)}m</span>
            </div>
          `).join('') : `<div style="color:var(--red)">‚ö†Ô∏è Brak materia≈Çu √ò${r.pos.diam}√ó${r.pos.thick}mm w magazynie!</div>`}
        </div>
      `).join('')}
      ${restoLines.length ? `
        <div class="divider"></div>
        <div class="card-title">Resty kt√≥re wr√≥cƒÖ</div>
        ${restoLines.map(r => `<div style="font-family:var(--mono);font-size:13px;padding:4px 0">Nr ${r.sig} ‚Äî ${r.len}m √ò${r.diam}√ó${r.thick}mm</div>`).join('')}
      ` : ''}
      <div class="divider"></div>
      <button class="btn btn-success btn-full" onclick="openEntnahme()">üìÑ Generuj Entnahmeschein</button>
    </div>
  `;
}

function openEntnahme() {
  if (!currentEntnahme) return;
  const e = currentEntnahme;
  document.getElementById('entnahmeBody').innerHTML = `
    <div class="entnahme-doc" id="entnahmePrint">
      <h2>Entnahmeschein</h2>
      <div class="entnahme-row">
        <div class="entnahme-field"><label>Projekt</label><div class="val">${e.nr}</div></div>
        <div class="entnahme-field"><label>Datum</label><div class="val">${formatDateDE(e.date)}</div></div>
      </div>
      <div class="entnahme-row">
        <div class="entnahme-field"><label>Bearbeiter</label><div class="val">${e.worker || ''}</div></div>
        <div class="entnahme-field"><label>Benennung</label><div class="val">${e.desc || ''}</div></div>
      </div>

      <div class="entnahme-section">
        <h3>Entnahme aus dem Stahlrohrlager</h3>
        <table class="entnahme-table">
          <tr><th>Chargennummer</th><th>Rohr-√ò √ó Wand</th><th>L√§nge (m)</th><th>Typ</th></tr>
          ${e.entnahme.filter(x=>x.type==='rura').map(x=>`
            <tr><td>${x.sig}</td><td>${x.diam}√ó${x.thick}</td><td>${parseFloat(x.len).toFixed(2)}</td><td>12m Rura</td></tr>
          `).join('') || '<tr><td colspan="4">‚Äî</td></tr>'}
        </table>
      </div>

      <div class="entnahme-section">
        <h3>Entnahme aus Restrohrlager</h3>
        <table class="entnahme-table">
          <tr><th>Nummer</th><th>Rohr-√ò √ó Wand</th><th>L√§nge (m)</th></tr>
          ${e.entnahme.filter(x=>x.type==='resto').map(x=>`
            <tr><td>${x.sig}</td><td>${x.diam}√ó${x.thick}</td><td>${parseFloat(x.len).toFixed(2)}</td></tr>
          `).join('') || '<tr><td colspan="3">‚Äî</td></tr>'}
        </table>
      </div>

      <div class="entnahme-section">
        <h3>Zugang Restrohrlager (zwrot)</h3>
        <table class="entnahme-table">
          <tr><th>Nummer</th><th>Rohr-√ò √ó Wand</th><th>L√§nge (m)</th><th>Projekt</th></tr>
          ${e.restos.map(r=>`
            <tr><td>${r.sig}</td><td>${r.diam}√ó${r.thick}</td><td>${r.len}</td><td>${r.proj}</td></tr>
          `).join('') || '<tr><td colspan="4">‚Äî</td></tr>'}
        </table>
      </div>

      <div style="margin-top:16px;display:flex;gap:40px">
        <div class="entnahme-field" style="flex:1"><label>Unterschrift Lager</label><div class="val" style="height:30px"></div></div>
        <div class="entnahme-field" style="flex:1"><label>Unterschrift Produktion</label><div class="val" style="height:30px"></div></div>
      </div>
    </div>
  `;
  document.getElementById('entnahmeModal').classList.add('open');
}

function printEntnahme() {
  const content = document.getElementById('entnahmePrint').innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`<html><body style="font-family:Arial;font-size:12px;padding:20px">${content}</body></html>`);
  w.document.close();
  w.print();
}

function exportTXT() {
  if (!currentEntnahme) return;
  const e = currentEntnahme;
  let txt = `ENTNAHMESCHEIN\n${'='.repeat(40)}\nProjekt: ${e.nr}\nDatum: ${formatDateDE(e.date)}\nBearbeiter: ${e.worker || '-'}\n\nENTNAHME STAHLROHRLAGER:\n`;
  e.entnahme.filter(x=>x.type==='rura').forEach(x => txt += `  ${x.sig} | √ò${x.diam}√ó${x.thick} | ${parseFloat(x.len).toFixed(2)}m\n`);
  txt += '\nENTNAHME RESTROHRLAGER:\n';
  e.entnahme.filter(x=>x.type==='resto').forEach(x => txt += `  ${x.sig} | √ò${x.diam}√ó${x.thick} | ${parseFloat(x.len).toFixed(2)}m\n`);
  txt += '\nZUGANG RESTROHRLAGER:\n';
  e.restos.forEach(r => txt += `  ${r.sig} | √ò${r.diam}√ó${r.thick} | ${r.len}m\n`);
  
  const blob = new Blob([txt], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `Entnahmeschein_${e.nr}.txt`; a.click();
}

function exportEmail() {
  if (!currentEntnahme) return;
  const e = currentEntnahme;
  const subject = encodeURIComponent(`Entnahmeschein - Projekt ${e.nr}`);
  const body = encodeURIComponent(`Projekt: ${e.nr}\nDatum: ${formatDateDE(e.date)}\n\nMateria≈Ç wys≈Çany na halƒô:\n${e.entnahme.map(x=>`${x.sig} (${parseFloat(x.len).toFixed(2)}m)`).join('\n')}`);
  window.open(`mailto:?subject=${subject}&body=${body}`);
}

// ===================== HISTORIA =====================
function addHistory(entry) {
  db.history.push({ ...entry, date: entry.date || new Date().toISOString() });
  saveDB();
}

function renderHistory() {
  searchHistory();
}

function searchHistory() {
  const q = (document.getElementById('histSearch').value || '').toLowerCase();
  const d = document.getElementById('histDate').value;
  
  let items = db.history;
  if (q) items = items.filter(h => JSON.stringify(h).toLowerCase().includes(q));
  if (d) items = items.filter(h => h.date && h.date.startsWith(d));
  items = [...items].reverse();

  const div = document.getElementById('historyResults');
  if (!items.length) {
    div.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><div>Brak wynik√≥w</div></div>`;
    return;
  }
  div.innerHTML = items.map(h => `
    <div class="card">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span class="badge ${h.type==='projekt'?'badge-blue':h.type==='add'?'badge-green':'badge-yellow'}">${h.type === 'projekt' ? 'PROJEKT' : h.type === 'add' ? 'DODANIE' : 'MODYFIKACJA'}</span>
        <span style="font-family:var(--mono);font-size:11px;color:var(--text2)">${formatDate(h.date)}</span>
      </div>
      <div style="font-weight:500;margin-bottom:4px">${h.projNr ? `Nr ${h.projNr}` : ''} ${h.sig || ''}</div>
      <div style="font-size:13px;color:var(--text2)">${h.desc || ''}</div>
      ${h.projNr ? `<button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="regenEntnahmeFromHistory('${h.date}')">üìÑ Regeneruj Entnahmeschein</button>` : ''}
    </div>
  `).join('');
}

function regenEntnahmeFromHistory(date) {
  const h = db.history.find(x => x.date === date && x.type === 'projekt');
  if (!h) return;
  currentEntnahme = {
    nr: h.projNr, date: h.date, desc: '', worker: h.worker || '',
    entnahme: h.entnahme || [], restos: h.restos || []
  };
  openEntnahme();
}

// ===================== ZADANIA =====================
function renderTasks() {
  const pending = db.tasks.filter(t => !t.done);
  const done = db.tasks.filter(t => t.done);
  const div = document.getElementById('tasksList');
  
  if (!pending.length && !done.length) {
    div.innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><div>Brak zada≈Ñ</div><div style="font-size:12px;margin-top:8px">Zadania pojawiajƒÖ siƒô automatycznie po wys≈Çaniu materia≈Çu na halƒô</div></div>`;
    return;
  }

  div.innerHTML = `
    ${pending.length ? `
      <div class="card-title" style="padding:0 0 8px">Do zrobienia (${pending.length})</div>
      ${pending.map(t => `
        <div class="task-card">
          <div class="task-title">${t.type === 'etykieta' ? 'üè∑ Zeskanuj etykietƒô' : 'üìã Zadanie'}</div>
          <div class="task-desc">${t.desc}</div>
          <div class="task-actions">
            ${t.type === 'etykieta' ? `<button class="btn btn-secondary btn-sm" onclick="scanRestoLabel('${t.id}')">üì∑ Skanuj etykietƒô</button>` : ''}
            <button class="btn btn-success btn-sm" onclick="completeTask('${t.id}')">‚úì Gotowe</button>
          </div>
        </div>
      `).join('')}
    ` : ''}
    ${done.length ? `
      <div class="card-title" style="padding:12px 0 8px">Uko≈Ñczone (${done.length})</div>
      ${done.slice(-5).map(t => `
        <div class="task-card" style="border-left-color:var(--green);opacity:0.6">
          <div class="task-title">‚úÖ ${t.type === 'etykieta' ? 'Etykieta zeskanowana' : 'Gotowe'}</div>
          <div class="task-desc">${t.desc}</div>
        </div>
      `).join('')}
    ` : ''}
  `;
}

function completeTask(id) {
  const t = db.tasks.find(x => x.id === id);
  if (t) { t.done = true; t.doneDate = new Date().toISOString(); }
  saveDB();
  renderTasks();
  const pending = db.tasks.filter(t => !t.done).length;
  document.getElementById('taskBadge').style.display = pending ? '' : 'none';
  document.getElementById('taskCount').textContent = pending + ' zada≈Ñ';
}

function scanRestoLabel(taskId) {
  const t = db.tasks.find(x => x.id === taskId);
  switchTab('skan');
  document.querySelectorAll('.tab').forEach((el,i) => { if(i===1) el.classList.add('active'); else el.classList.remove('active'); });
  // Pre-fill form
  setTimeout(() => {
    showManualForm();
    if (t && t.restoSig) document.getElementById('fSig').value = t.restoSig;
    if (t && t.restoLen) document.getElementById('fLen').value = t.restoLen;
    if (parseFloat(t?.restoLen) < 6) document.getElementById('fType').value = 'resto';
    completeTask(taskId);
  }, 100);
}

// ===================== UTILS =====================
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('pl-PL', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

function formatDateDE(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' });
}

// ===================== INIT =====================
renderBaza();
</script>
</body>
</html>
